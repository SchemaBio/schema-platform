# Schema Platform - Docker Compose 配置
#
# 使用方法:
# 1. 复制 .env.example 为 .env 并修改配置
# 2. 使用 ./start.sh 启动 (推荐)
#    或直接: docker-compose up -d
#
# 注意事项:
# - 默认启动内置 PostgreSQL
# - 设置 SKIP_POSTGRES=true 可跳过 PostgreSQL 容器

services:
  # ============================================
  # PostgreSQL 数据库
  # ============================================
  postgres:
    image: postgres:18-alpine
    env_file:
      - .env
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-schema_platform}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # 不暴露端口，仅内部网络使用

  # ============================================
  # Germline 前端
  # ============================================
  web-germline:
    build:
      context: ./apps/web-germline
    ports:
      - "${GERMLINE_WEB_PORT:-3001}:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://backend-germline:8080
    depends_on:
      backend-germline:
        condition: service_healthy
    profiles:
      - germline
      - all

  # ============================================
  # Somatic 前端
  # ============================================
  web-somatic:
    build:
      context: ./apps/web-somatic
    ports:
      - "${SOMATIC_WEB_PORT:-3002}:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://backend-somatic:8080
    depends_on:
      backend-somatic:
        condition: service_healthy
    profiles:
      - somatic
      - all

  # ============================================
  # 后端 (Germline 模式)
  # ============================================
  backend-germline:
    build:
      context: ./apps/backend-api
      args:
        ANALYSIS_TYPE: germline
    environment:
      - SCHEMA_DATABASE_HOST=${POSTGRES_HOST:-postgres}
      - SCHEMA_DATABASE_PORT=${POSTGRES_PORT:-5432}
      - SCHEMA_DATABASE_USER=${POSTGRES_USER:-postgres}
      - SCHEMA_DATABASE_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - SCHEMA_DATABASE_DBNAME=${POSTGRES_DB:-schema_platform}
      - SCHEMA_SERVER_HOST=0.0.0.0
      - SCHEMA_SERVER_PORT=8080
      - SCHEMA_ANALYSIS_TYPE=germline
    depends_on:
      postgres:
        condition: service_healthy
    profiles:
      - germline
      - all
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================
  # 后端 (Somatic 模式)
  # ============================================
  backend-somatic:
    build:
      context: ./apps/backend-api
      args:
        ANALYSIS_TYPE: somatic
    environment:
      - SCHEMA_DATABASE_HOST=${POSTGRES_HOST:-postgres}
      - SCHEMA_DATABASE_PORT=${POSTGRES_PORT:-5432}
      - SCHEMA_DATABASE_USER=${POSTGRES_USER:-postgres}
      - SCHEMA_DATABASE_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - SCHEMA_DATABASE_DBNAME=${POSTGRES_DB:-schema_platform}
      - SCHEMA_SERVER_HOST=0.0.0.0
      - SCHEMA_SERVER_PORT=8080
      - SCHEMA_ANALYSIS_TYPE=somatic
    depends_on:
      postgres:
        condition: service_healthy
    profiles:
      - somatic
      - all
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3

volumes:
  postgres_data:
