# Schema Platform - Docker Compose 配置
#
# 使用方法:
#   ./start.sh               # 启动所有服务
#   ./start.sh germline      # 只启动 Germline
#   ./start.sh somatic       # 只启动 Somatic
#   ./start.sh --external-db # 使用外部数据库

services:
  # ============================================
  # PostgreSQL 数据库 (内置)
  # ============================================
  postgres:
    image: postgres:18-alpine
    env_file:
      - .env
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-schema_platform}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # 不暴露端口，仅内部网络使用

  # ============================================
  # Germline 前端
  # ============================================
  web-germline:
    image: ghcr.io/schemabio/schema-germline:latest
    ports:
      - "${GERMLINE_WEB_PORT:-3001}:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://backend-germline:8080
    depends_on:
      backend-germline:
        condition: service_healthy

  # ============================================
  # Somatic 前端
  # ============================================
  web-somatic:
    image: ghcr.io/schemabio/schema-somatic:latest
    ports:
      - "${SOMATIC_WEB_PORT:-3002}:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://backend-somatic:8080
    depends_on:
      backend-somatic:
        condition: service_healthy

  # ============================================
  # 后端 (Germline 模式)
  # ============================================
  backend-germline:
    image: ghcr.io/schemabio/schema-backend:latest
    environment:
      - SCHEMA_DATABASE_HOST=${POSTGRES_HOST:-postgres}
      - SCHEMA_DATABASE_PORT=${POSTGRES_PORT:-5432}
      - SCHEMA_DATABASE_USER=${POSTGRES_USER:-postgres}
      - SCHEMA_DATABASE_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - SCHEMA_DATABASE_DBNAME=${POSTGRES_DB:-schema_platform}
      - SCHEMA_SERVER_HOST=0.0.0.0
      - SCHEMA_SERVER_PORT=8080
      - SCHEMA_ANALYSIS_TYPE=germline
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================
  # 后端 (Somatic 模式)
  # ============================================
  backend-somatic:
    image: ghcr.io/schemabio/schema-backend:latest
    environment:
      - SCHEMA_DATABASE_HOST=${POSTGRES_HOST:-postgres}
      - SCHEMA_DATABASE_PORT=${POSTGRES_PORT:-5432}
      - SCHEMA_DATABASE_USER=${POSTGRES_USER:-postgres}
      - SCHEMA_DATABASE_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - SCHEMA_DATABASE_DBNAME=${POSTGRES_DB:-schema_platform}
      - SCHEMA_SERVER_HOST=0.0.0.0
      - SCHEMA_SERVER_PORT=8080
      - SCHEMA_ANALYSIS_TYPE=somatic
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3

volumes:
  postgres_data:
