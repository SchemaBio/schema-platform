# Schema Platform - Docker Compose 配置 (外部数据库版本)
#
# 使用方法:
#   ./start.sh --external-db
#
# 使用预构建镜像:
#   - ghcr.io/schemabio/schema-germline
#   - ghcr.io/schemabio/schema-somatic
#   - ghcr.io/schemabio/schema-backend

services:
  # ============================================
  # Germline 前端
  # ============================================
  web-germline:
    image: ghcr.io/schemabio/schema-germline:latest
    ports:
      - "${GERMLINE_WEB_PORT:-3001}:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://backend-germline:8080

  # ============================================
  # Somatic 前端
  # ============================================
  web-somatic:
    image: ghcr.io/schemabio/schema-somatic:latest
    ports:
      - "${SOMATIC_WEB_PORT:-3002}:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://backend-somatic:8080

  # ============================================
  # 后端 (Germline 模式)
  # ============================================
  backend-germline:
    image: ghcr.io/schemabio/schema-backend:latest
    environment:
      - SCHEMA_DATABASE_HOST=${POSTGRES_HOST:-postgres}
      - SCHEMA_DATABASE_PORT=${POSTGRES_PORT:-5432}
      - SCHEMA_DATABASE_USER=${POSTGRES_USER:-postgres}
      - SCHEMA_DATABASE_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - SCHEMA_DATABASE_DBNAME=${POSTGRES_DB:-schema_platform}
      - SCHEMA_SERVER_HOST=0.0.0.0
      - SCHEMA_SERVER_PORT=8080
      - SCHEMA_ANALYSIS_TYPE=germline
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================
  # 后端 (Somatic 模式)
  # ============================================
  backend-somatic:
    image: ghcr.io/schemabio/schema-backend:latest
    environment:
      - SCHEMA_DATABASE_HOST=${POSTGRES_HOST:-postgres}
      - SCHEMA_DATABASE_PORT=${POSTGRES_PORT:-5432}
      - SCHEMA_DATABASE_USER=${POSTGRES_USER:-postgres}
      - SCHEMA_DATABASE_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - SCHEMA_DATABASE_DBNAME=${POSTGRES_DB:-schema_platform}
      - SCHEMA_SERVER_HOST=0.0.0.0
      - SCHEMA_SERVER_PORT=8080
      - SCHEMA_ANALYSIS_TYPE=somatic
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
