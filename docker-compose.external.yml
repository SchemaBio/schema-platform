# Schema Platform - Docker Compose 配置 (外部数据库版本)
#
# 使用方法:
#   USE_EXTERNAL_DB=true docker compose -f docker-compose.external.yml up -d
#
# 或使用启动脚本:
#   ./start.sh --external-db

services:
  # ============================================
  # Germline 前端
  # ============================================
  web-germline:
    build:
      context: ./apps/web-germline
    ports:
      - "${GERMLINE_WEB_PORT:-3001}:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://backend-germline:8080

  # ============================================
  # Somatic 前端
  # ============================================
  web-somatic:
    build:
      context: ./apps/web-somatic
    ports:
      - "${SOMATIC_WEB_PORT:-3002}:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://backend-somatic:8080

  # ============================================
  # 后端 (Germline 模式)
  # ============================================
  backend-germline:
    build:
      context: ./apps/backend-api
      args:
        ANALYSIS_TYPE: germline
    environment:
      - SCHEMA_DATABASE_HOST=${POSTGRES_HOST:-postgres}
      - SCHEMA_DATABASE_PORT=${POSTGRES_PORT:-5432}
      - SCHEMA_DATABASE_USER=${POSTGRES_USER:-postgres}
      - SCHEMA_DATABASE_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - SCHEMA_DATABASE_DBNAME=${POSTGRES_DB:-schema_platform}
      - SCHEMA_SERVER_HOST=0.0.0.0
      - SCHEMA_SERVER_PORT=8080
      - SCHEMA_ANALYSIS_TYPE=germline
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3

  # ============================================
  # 后端 (Somatic 模式)
  # ============================================
  backend-somatic:
    build:
      context: ./apps/backend-api
      args:
        ANALYSIS_TYPE: somatic
    environment:
      - SCHEMA_DATABASE_HOST=${POSTGRES_HOST:-postgres}
      - SCHEMA_DATABASE_PORT=${POSTGRES_PORT:-5432}
      - SCHEMA_DATABASE_USER=${POSTGRES_USER:-postgres}
      - SCHEMA_DATABASE_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - SCHEMA_DATABASE_DBNAME=${POSTGRES_DB:-schema_platform}
      - SCHEMA_SERVER_HOST=0.0.0.0
      - SCHEMA_SERVER_PORT=8080
      - SCHEMA_ANALYSIS_TYPE=somatic
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
