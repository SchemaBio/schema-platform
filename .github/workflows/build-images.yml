name: Build Images

on:
  push:
    branches: [main, develop]
    tags: ['v*']
    paths:
      - 'apps/web-germline/**'
      - 'apps/web-somatic/**'
      - 'apps/backend-api/**'
      - 'packages/**'
      - 'pnpm-*.yaml'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      germline:
        description: 'Build Germline image'
        type: boolean
        default: false
      somatic:
        description: 'Build Somatic image'
        type: boolean
        default: false
      backend:
        description: 'Build Backend image'
        type: boolean
        default: false
      version:
        description: 'Version tag (e.g., v1.0.0)'
        type: string
        default: ''

env:
  REGISTRY: ghcr.io
  ORGANIZATION: schemabio

jobs:
  # ============================================
  # 1. 解析 commit 和 tag，确定构建目标
  # ============================================
  detect-targets:
    name: Detect Build Targets
    runs-on: ubuntu-latest
    outputs:
      germline: ${{ steps.parse.outputs.germline }}
      somatic: ${{ steps.parse.outputs.somatic }}
      backend: ${{ steps.parse.outputs.backend }}
      version: ${{ steps.parse.outputs.version }}
      is_release: ${{ steps.parse.outputs.is_release }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest commit message
        id: commit
        run: |
          echo "message=$(git log -1 --format='%s')" >> $GITHUB_OUTPUT

      - name: Parse commit and tag
        id: parse
        run: |
          # 默认不构建任何镜像
          GERMLINE=false
          SOMATIC=false
          BACKEND=false
          VERSION=""
          IS_RELEASE=false
          IS_PRERELEASE=false

          # 检查是否是 tag push
          if [[ "${{ github.ref }}" =~ refs/tags/ ]]; then
            TAG_NAME="${GITHUB_REF##refs/tags/}"
            VERSION="$TAG_NAME"
            IS_RELEASE=true

            # 解析 tag 确定构建目标
            # 格式: v1.0.0, v1.0.0-germline, v1.0.0-somatic
            if [[ "$TAG_NAME" =~ ^v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
              # v1.0.0 格式，构建所有
              GERMLINE=true
              SOMATIC=true
              BACKEND=true
            elif [[ "$TAG_NAME" =~ ^v([0-9]+\.[0-9]+\.[0-9]+)-germline$ ]]; then
              GERMLINE=true
              BACKEND=true
            elif [[ "$TAG_NAME" =~ ^v([0-9]+\.[0-9]+\.[0-9]+)-somatic$ ]]; then
              SOMATIC=true
              BACKEND=true
            fi
          else
            # 从 commit message 解析
            # 只识别格式: backend: v1.0.0, germline: v1.0.0, somatic: v1.0.0
            MSG="${{ steps.commit.outputs.message }}"

            # 检查是否是发布提交: scope: v1.0.0
            if [[ "$MSG" =~ ^(backend|germline|somatic):[[:space:]]+v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
              SCOPE="${BASH_REMATCH[1]}"
              VERSION="v${BASH_REMATCH[2]}"
              IS_RELEASE=true

              case "$SCOPE" in
                germline)
                  GERMLINE=true
                  # Germline 发布只构建前端，不构建后端
                  ;;
                somatic)
                  SOMATIC=true
                  # Somatic 发布只构建前端，不构建后端
                  ;;
                backend)
                  BACKEND=true
                  ;;
              esac
            fi
          fi

          # 检查是否是 prerelease（如 v1.0.0beta, v1.0.0-alpha）
          if [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+[a-z] ]]; then
            IS_PRERELEASE=true
          fi

          echo "commit_message=${{ steps.commit.outputs.message }}" >> $GITHUB_OUTPUT
          echo "scope=$SCOPE" >> $GITHUB_OUTPUT
          echo "germline=$GERMLINE" >> $GITHUB_OUTPUT
          echo "somatic=$SOMATIC" >> $GITHUB_OUTPUT
          echo "backend=$BACKEND" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

  # ============================================
  # 2. 构建 Germline 前端
  # ============================================
  build-germline:
    name: Build Germline
    needs: detect-targets
    if: github.event_name == 'workflow_dispatch' && inputs.germline || (needs.detect-targets.outputs.germline == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Germline
        id: meta-germline
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.ORGANIZATION }}/schema-germline
          tags: |
            type=raw,value=${{ needs.detect-targets.outputs.version }}
            type=sha
            type=ref,event=tag
            type=raw,value=latest,enable=${{ !needs.detect-targets.outputs.is_prerelease }}

      - name: Build and push Germline
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web-germline
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-germline.outputs.tags }}
          labels: ${{ steps.meta-germline.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # 3. 构建 Somatic 前端
  # ============================================
  build-somatic:
    name: Build Somatic
    needs: detect-targets
    if: github.event_name == 'workflow_dispatch' && inputs.somatic || (needs.detect-targets.outputs.somatic == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Somatic
        id: meta-somatic
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.ORGANIZATION }}/schema-somatic
          tags: |
            type=raw,value=${{ needs.detect-targets.outputs.version }}
            type=sha
            type=ref,event=tag
            type=raw,value=latest,enable=${{ !needs.detect-targets.outputs.is_prerelease }}

      - name: Build and push Somatic
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web-somatic
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta-somatic.outputs.tags }}
          labels: ${{ steps.meta-somatic.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # 4. 构建 Backend
  # ============================================
  build-backend:
    name: Build Backend
    needs: detect-targets
    if: github.event_name == 'workflow_dispatch' && inputs.backend || (needs.detect-targets.outputs.backend == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Germline 版本
      - name: Extract metadata for Backend (Germline)
        id: meta-germline
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.ORGANIZATION }}/schema-backend
          tags: |
            type=raw,value=germline-${{ needs.detect-targets.outputs.version }},enable=${{ !needs.detect-targets.outputs.is_prerelease }}
            type=raw,value=germline,enable=${{ !needs.detect-targets.outputs.is_prerelease }}
            type=sha

      - name: Build and push Backend (Germline)
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend-api
          push: ${{ github.event_name != 'pull_request' }}
          build-args: ANALYSIS_TYPE=germline
          tags: ${{ steps.meta-germline.outputs.tags }}
          labels: ${{ steps.meta-germline.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Somatic 版本
      - name: Extract metadata for Backend (Somatic)
        id: meta-somatic
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.ORGANIZATION }}/schema-backend
          tags: |
            type=raw,value=somatic-${{ needs.detect-targets.outputs.version }},enable=${{ !needs.detect-targets.outputs.is_prerelease }}
            type=raw,value=somatic,enable=${{ !needs.detect-targets.outputs.is_prerelease }}
            type=sha

      - name: Build and push Backend (Somatic)
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend-api
          push: ${{ github.event_name != 'pull_request' }}
          build-args: ANALYSIS_TYPE=somatic
          tags: ${{ steps.meta-somatic.outputs.tags }}
          labels: ${{ steps.meta-somatic.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # 5. 汇总
  # ============================================
  summary:
    name: Summary
    needs: [build-germline, build-somatic, build-backend]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.detect-targets.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ needs.detect-targets.outputs.commit_message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| schema-germline | ${{ needs.build-germline.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| schema-somatic | ${{ needs.build-somatic.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| schema-backend (germline) | ${{ needs.build-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| schema-backend (somatic) | ${{ needs.build-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Images" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/${{ env.ORGANIZATION }}/schema-germline:${{ needs.detect-targets.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/${{ env.ORGANIZATION }}/schema-somatic:${{ needs.detect-targets.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/${{ env.ORGANIZATION }}/schema-backend:${{ needs.detect-targets.outputs.version }}" >> $GITHUB_STEP_SUMMARY
